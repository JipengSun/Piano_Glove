#! /usr/bin/env python3

import matplotlib.pyplot as plt
import numpy as np
from scipy import signal
np.random.seed(42)

test = [ 0.000037,
0.000088, 0.000140, 0.000192, 0.000248, 0.000301,
0.000350, 0.000393, 0.000432, 0.000452, 0.000464,
0.000459, 0.000442, 0.000406, 0.000356, 0.000291,
0.000215, 0.000127, 0.000023, -0.000088, -0.000208,
-0.000333, -0.000458, -0.000580, -0.000690, -0.000794,
-0.000890, -0.000971, -0.001028, -0.001061, -0.001080,
-0.001075, -0.001034, -0.000969, -0.000878, -0.000757,
-0.000618, -0.000448, -0.000254, -0.000038, 0.000191,
0.000435, 0.000685, 0.000942, 0.001195, 0.001442,
-0.001178, -0.002333, -0.003489,
-0.004628, -0.005725, -0.006766, -0.007725, -0.008581,
-0.009323, -0.009934, -0.010396, -0.010697, -0.010827,
-0.010774, -0.010540, -0.010114, -0.009498, -0.008703,
-0.007726, -0.006586, -0.005293, -0.003868, -0.002325,
-0.000695, 0.001009, 0.002753, 0.004511, 0.006250,
0.007943, 0.009564, 0.011075, 0.012456, 0.013671,
0.014703, 0.015520, 0.016110, 0.016452, 0.016529,
0.016338, 0.015870, 0.015121, 0.014097, 0.012804,
0.011264, 0.009484, 0.007496, 0.005321, 0.002994,
0.000543, -0.001993, -0.004570, -0.007152, -0.009694,
-0.012152, -0.014490, -0.016655, -0.018610, -0.020322,
-0.021749, -0.022860, -0.023629, -0.024032, -0.024047,
-0.023668, -0.022895, -0.021719, -0.020149, -0.018203,
-0.015900, -0.013264, -0.010335, -0.007152, -0.003756,
-0.000200, 0.003463, 0.007177, 0.010887, 0.014523,
0.018035, 0.021355, 0.024420, 0.027181, 0.029576,
0.031567, 0.033105, 0.034150, 0.034674, 0.034658,
0.034078, 0.032929, 0.031224, 0.028969, 0.026180,
0.022893, 0.019146, 0.014979, 0.010454, 0.005636,
0.000592, -0.004607, -0.009885, -0.015148, -0.020327,
-0.025329, -0.030070, -0.034466, -0.038441, -0.041921,
-0.044837, -0.047128, -0.048739, -0.049635, -0.049770,
-0.049125, -0.047692, -0.045466, -0.042463, -0.038703,
-0.034228, -0.029093, -0.023353, -0.017081, -0.010361,
-0.003280, 0.004058, 0.011550, 0.019091, 0.026565,
0.033850, 0.040841, 0.047414, 0.053465, 0.058889,
0.063582, 0.067457, 0.070430, 0.072434, 0.073411,
0.073317, 0.072124, 0.069815, 0.066396, 0.061885,
0.056313, 0.049730, 0.042202, 0.033809, 0.024643,
0.014805, 0.004415, -0.006402, -0.017506, -0.028760,
-0.040017, -0.051130, -0.061948, -0.072323, -0.082112,
-0.091182, -0.099401, -0.106651, -0.112821, -0.117820,
-0.121563, -0.123996, -0.125064, -0.124740, -0.123015,
-0.119893, -0.115414, -0.109625, -0.102587, -0.094391,
-0.085131, -0.074930, -0.063913, -0.052232, -0.040039,
-0.027501, -0.014780, -0.002065, 0.010476, 0.022657,
0.034303, 0.045242, 0.055309, 1.109893, 1.259473,
0.956085, 0.791080, 0.765344, 0.594434, 0.445489,
0.311548, 0.277008, -0.126816, -0.142311, -0.390074,
-0.396228, -0.625146, -0.679944, -0.747011, -0.702570,
-0.743668, -0.931963, -0.821569, -0.855252, -0.851371,
-0.701230, -0.624411, -0.306258, -0.353676, -0.376423,
-0.182223, 0.077803, 0.297072, 0.134582, 0.236977,
0.654411, 0.641890, 0.633362, 0.821617, 0.626072,
0.875964, 0.920376, 0.965753, 0.787542, 0.832009,
0.688209, 0.701740, 0.512529, 0.440322, 0.270585,
0.270875, 0.150224, -0.077099, -0.194589, -0.449124,
-0.485939, -0.584906, -0.477581, -0.867544, -0.735618,
-0.828266, -0.920590, -0.816261, -0.919599, -0.889241,
-0.874795, -0.703036, -0.625286, -0.658773, -0.595874,
-0.376701, -0.285990, -0.083063, 0.167341, 0.177131,
0.351449, 0.493304, 0.679934, 0.542518, 0.768284,
0.910426, 1.046648, 0.947475, 0.851105, 1.043054,
0.912836, 0.817239, 0.790860, 0.735619, 0.594725,
0.344865, 0.459445, 0.347125, 0.148943, -0.145015,
-0.220103, -0.350346, -0.440382, -0.562838, -0.789775,
-0.823387, -0.874239, -0.855402, -0.955363, -0.966377,
-1.018087, -0.884856, -0.916024, -0.948088, -0.678139,
-0.628580, -0.598992, -0.468849, -0.264464, -0.102754,
0.027146, 0.186879, 0.444691, 0.533980, 0.592825,
0.769084, 0.711689, 0.908733, 1.084517, 0.964080,
0.933431, 0.946342, 0.886226, 0.863707, 0.829200,
0.659536, 0.669116, 0.621021, 0.344940, 0.398543,
0.171151, 0.063171, -0.220969, -0.245204, -0.539049,
-0.508401, -0.680746, -0.749460, -0.969137, -1.008365,
-0.929565, -1.071805, -0.955046, -1.075297, -0.850123,
-0.947937, -0.717329, -0.606435, -0.592329, -0.357934,
-0.242331, -0.158868, -0.046249, 0.027040, 0.357711,
0.343042, 0.604042, 0.690345, 0.864992, 0.867732,
0.926941, 1.052017, 1.038283, 1.032193, 1.017355,
0.807943, 0.921447, 0.820667, 0.583723, 0.523891,
0.406278, 0.255273, 0.143127, 0.078394, -0.101656,
-0.441444, -0.427871, -0.502277, -0.695501, -0.741313,
-0.751793, -0.895254, -1.000352, -0.957672, -1.028072,
-1.013578, -0.997446, -0.777147, -0.881168, -0.589082,
-0.552516, -0.572811, -0.290277, -0.340148, 0.028533,
0.199649, 0.228129, 0.425183, 0.701389, 0.621423,
0.678478, 0.965265, 1.067655, 0.953808, 1.055322,
1.080185, 0.889545, 0.864375, 0.935144, 0.885660,
0.692733, 0.459146, 0.557976, 0.216585, 0.086040,
-0.008957, -0.060831, -0.261955, -0.435210, -0.559368,
-0.708013, -0.766341, -1.095053, -0.978444, -0.976385,
-1.106742, -0.980276, -1.001670, -0.797159, -0.743259,
-0.818583, -0.688246, -0.561932, -0.459614, -0.265917,
-0.193937, -0.072477, 0.218687, 0.366430, 0.391962,
0.658119, 0.653199, 0.825685, 0.954986, 0.950973,
1.033324, 0.976934, 1.001422, 0.977194, 0.888640,
0.868159, 0.673061, 0.654969, 0.553744, 0.425935,
0.287546, 0.156039, 0.050400, -0.066642, -0.333612,
-0.516048, -0.631362, -0.702354, -0.791508, -0.907300,
-1.012270, -0.987084, -0.956311, -0.921224, -0.989264,
-0.931937, -0.906699, -0.749681, -0.712523, -0.481462,
-0.540694, -0.287863, -0.090168, 0.048126, 0.396047,
0.351952, 0.379963, 0.578845, 0.557586, 0.790908,
0.810614, 1.010829, 0.933012, 0.985150, 0.938878,
1.101871, 0.888466, 0.991620, 0.821953, 0.690105,
0.561002, 0.430880, 0.103882, 0.088482, 0.028375,
-0.192550, -0.446494, -0.476509, -0.463938, -0.615326,
-0.819151, -0.819255, -0.986136, -1.133461, -1.089413,
-0.886293, -1.006772, -0.956068, -0.891630, -0.627178,
-0.544082, -0.376421, -0.434209, -0.256121, -0.253269,
0.136889, 0.075467, 0.332548, 0.366652, 0.536391,
0.632544, 0.751314, 0.839415, 0.901655, 1.054146,
0.919108, 1.022820, 1.078036, 0.893271, 0.810007,
0.763010, 0.772701, 0.575905, 0.387789, 0.329690,
0.057414, 0.051928, -0.117537, -0.318640, -0.497797,
-0.628169, -0.627951, -0.670348, -0.899815, -0.872733,
-1.116005, -1.013607, -0.964876, -1.008569, -0.962566,
-0.872439, -0.708064, -0.641873, -0.686757, -0.546199,
-0.284916, -0.053716, -0.161516, 0.166181, 0.307853,
0.597488, 0.581687, 0.755957, 0.833651, 0.730938,
1.022093, 1.015963, 1.055441, 1.322506, 0.812945,
1.067219, 0.835157, 0.790977, 0.657082, 0.504760,
0.359035, 0.287808, -0.009042, 0.020630, -0.223747,
-0.427825, -0.513071, -0.505735, -0.765106, -0.793723,
-0.962954, -0.906044, -0.952803, -0.878580, -1.036792,
-0.943086, -0.940708, -0.776077, -0.849211, -0.626788,
-0.581729, -0.438818, -0.284588, -0.123871, -0.002652,
0.173997, 0.429385, 0.521161, 0.640832, 0.650752,
0.716307, 0.946265, 1.002641, 1.092029, 0.945591,
0.972871, 0.835104, 0.888191, 0.932000, 0.728528,
0.713519, 0.528641, 0.439268, 0.181771, 0.134587,
-0.260135, -0.183855, -0.443539, -0.353703, -0.514896,
-0.653631, -0.667577, -0.945684, -0.790903, -0.896095,
-1.007741, -0.893862, -1.046968, -0.976609, -0.891047,
-0.797448, -0.735439, -0.434198, -0.421912, -0.233116,
-0.161160, -0.112769, 0.202206, 0.171326, 0.455288,
0.477478, 0.858980, 0.870282, 0.885355, 1.037880,
0.907981, 1.036210, 1.003517, 0.981324, 1.013143,
0.900677, 0.777016, 0.516471, 0.452455, 0.387981,
0.264887, 0.020841, 0.155553, -0.063869, -0.280643,
-0.459299, -0.607824, -0.779504, -0.793838, -0.858100,
-1.036956, -0.948659, -1.003612, -1.137245, -1.024642,
-0.938476, -0.683427, -0.700033, -0.744547, -0.477370,
-0.506689, -0.153989, -0.130224, 0.050540, 0.313795,
0.250266, 0.379567, 0.572237, 0.816255, 0.710002,
0.685277, 0.936212, 1.055702, 1.124774, 0.986441,
0.962995, 1.038926, 0.727128, 0.756697, 0.697021,
0.597043, 0.387643, 0.289469, -0.059949, -0.063713,
-0.124184, -0.384363, -0.439049, -0.535598, -0.713103,
-0.770633, -0.941897, -0.942253, -0.916650, -0.970692,
-1.025610, -0.933964, -0.846329, -0.998605, -0.654036,
-0.668868, -0.488533, -0.295494, -0.360776, -0.161767,
0.020444, 0.128527, 0.473569, 0.402374, 0.552165,
0.725371, 0.709431, 0.852541, 0.968409, 0.954096,
0.988995, 0.947529, 0.839919, 0.936440, 0.980290,
0.751643, 0.661580, 0.577840, 0.287905, 0.383831,
0.116279, 0.080712, -0.257482, -0.198130, -0.418810,
-0.563262, -0.702075, -0.838042, -0.801377, -0.945568,
-1.152335, -1.100451, -1.019619, -0.951337, -0.930396,
-0.757540, -0.921382, -0.647066, -0.682675, -0.343254,
-0.269477, -0.080494, -0.032876, 0.287998, 0.414131,
0.515164, 0.585260, 0.755777, 0.750680, 0.955428,
1.078831, 1.071207, 0.943811, 1.025298, 0.864832,
0.964334, 0.884302, 0.609418, 0.559861, 0.509368,
0.375283, 0.161033, 0.141610, -0.019126, -0.203602,
-0.393086, -0.385794, -0.463768, -0.748008, -0.855484,
-0.846279, -0.973392, -0.993851, -0.939398, -1.144738,
-0.857608, -0.906664, -0.874230, -0.758281, -0.646986,
-0.660702, -0.268906, -0.242555, -0.061993, 0.129595,
0.121808, 0.387211, 0.466317, 0.683362, 0.559985,
0.820901, 0.861206, 1.004779, 1.047392, 0.970719,
0.965493, 0.986471, 0.874794, 0.944549, 0.759334,
0.451007, 0.533672, 0.348735, 0.160512, 0.045424,
0.004053, -0.046715, -0.272124, -0.482513, -0.523910,
-0.710261, -0.826500, -0.942747, -1.050316, -0.980121,
-0.953172, -0.968217, -0.966350, -0.959864, -0.766341,
-0.832410, -0.560224, -0.583372, -0.432568, -0.350157,
-0.127767, 0.137832, 0.247505, 0.426655, 0.524732,
0.518647, 0.691073, 0.749822, 0.995331, 0.849980,
1.052968, 1.066724, 1.133195, 0.923467, 0.961201,
1.014392, 0.691358, 0.510163, 0.360431, 0.434124,
0.084062, 0.057070, -0.028207, -0.197272, -0.322465,
-0.475443, -0.516896, -0.807820, -0.882158, -0.967959,
-0.897905, -0.929204, -0.979964, -0.913775, -1.072835,
-0.793739, -0.733334, -0.705575, -0.514275, -0.667316,
-0.442992, -0.317381, -0.052804, -0.044263, 0.249524,
0.443302, 0.526344, 0.619782, 0.630855, 0.738880,
0.985124, 1.006052, 0.977840, 0.962673, 0.826736,
0.873542, 1.060894, 0.733803, 0.760780, 0.718730,
0.415765, 0.397210, 0.314962, 0.092819, 0.170900,
-0.341410, -0.268165, -0.504026, -0.555091, -0.694689,
-0.885765, -0.887728, -1.113682, -0.954530, -0.994594,
-0.960576, -0.897961, -0.902507, -0.848904, -0.841171,
-0.720710, -0.447351, -0.294163, -0.286107, -0.115729,
-0.041800, 0.273360, 0.377405, 0.616555, 0.517452,
0.670523, 0.816388, 0.928596, 0.918783, 0.904196,
1.060565, 1.041420, 0.881932, 1.013665, 0.928457,
0.756406, 0.646072, 0.563681, 0.318381, 0.248976,
-0.071921, 0.021829, -0.320715, -0.218642, -0.500877,
-0.616321, -0.761101, -0.829496, -0.770472, -1.140682,
-0.876094, -0.965897, -1.081961, -1.041812, -0.770664,
-0.909172, -0.835906, -0.546129, -0.489285, -0.459150,
-0.225987, -0.179205, 0.139191, 0.283064, 0.383184,
0.504274, 0.740169, 0.709592, 0.709346, 0.915941,
1.103045, 0.889954, 0.955207, 1.008125, 0.939079,
0.811966, 0.907205, 0.911338, 0.633104, 0.422595,
0.237074, 0.239245, 0.159274, -0.040633, -0.227074,
-0.417555, -0.593392, -0.563880, -0.668435, -0.959821,
-0.785202, -0.922580, -0.891258, -1.123132, -1.115061,
-0.985443, -0.879424, -0.701630, -0.695751, -0.661803,
-0.600325, -0.284063, -0.315326, 0.041831, 0.040543,
0.340989, 0.413852, 0.486497, 0.582892, 0.710404,
0.868913, 0.919374, 0.924088, 0.995302, 1.029539,
0.845067, 1.021747, 0.854722, 0.768300, 0.634111,
0.517234, 0.429493, 0.346662, 0.416369, 0.069201,
-0.025556, -0.157653, -0.324658, -0.479085, -0.695507,
-0.597214, -0.666040, -1.024313, -1.030719, -1.008993,
-1.079481, -0.955116, -1.024878, -0.742849, -0.749826,
-0.738258, -0.566510, -0.439219, -0.440179, -0.319059,
-0.100705, 0.110979, 0.201019, 0.207107, 0.404725,
0.587985, 0.699258, 0.958491, 0.766987, 0.975588,
1.090343, 1.166993, 0.944648, 0.985896, 0.940273,
0.838126, 0.723671, 0.658885, 0.299582, 0.423362,
0.236951, 0.061742, 0.093892, -0.272012, -0.393858,
-0.338103, -0.688999, -0.777846, -0.840891, -0.838930,
-0.946663, -1.102567, -1.055565, -1.053061, -0.979972,
-0.887576, -0.815732, -0.900132, -0.565131, -0.507988,
-0.283858, -0.216971, -0.016921, 0.081843, 0.300513,
0.378314, 0.464631, 0.779399, 0.780263, 0.850496,
0.779745, 0.836123, 0.998761, 1.001152, 0.932272,
0.962487, 1.026716, 0.883443, 0.646112, 0.621506,
0.444906, 0.345749, 0.202705, 0.051334, -0.159085,
-0.215737, -0.392569, -0.716419, -0.441267, -0.628202,
-0.839070, -0.882866, -1.033563, -0.838415, -0.834550,
-0.963785, -0.862355, -0.876771, -0.924113, -0.757961,
-0.605819, -0.530024, -0.377108, -0.224550, -0.076174,
0.083873, 0.142752, 0.313369, 0.403101, 0.708232,
0.571883, 0.926702, 1.021027, 0.941584]
fig = plt.figure()
ax = fig.add_subplot(1, 1, 1)
plt.ylim(-2, 2)
plt.plot(test)
print(len(test))

def write_array(f, a, name):
    s = "const float " + name + "[" + str(len(a)) + "] =\n{\n  "
    for i,x in enumerate(a):
        if i % 10 == 0:
            s += "\n  "
        s += str(x) + ", "
    f.write(s)
    f.write("};\n\n")

taps = signal.firwin(599, 50, pass_zero='highpass', fs=42*60)

with open("coeff.c", "w") as f:
    f.write("// Automatically generated by `raw_to_c_array.py'\n\n")
    f.write("#include \"stdint.h\"\n\n")
    write_array(f, taps, 'coeff')


w, h = signal.freqz(taps, 1.0, 2000, fs=42*60)

fig = plt.figure()
ax = fig.add_subplot(1, 1, 1)
ax.set_title('frequency response')
ax.set_xlabel('Frequency [Hz]')
ax.set_ylabel('Amplitude [dB]')
plt.plot(w, 20 * np.log10(np.maximum(abs(h), 1e-5)))
ax.grid(which='both', axis='both')
ax2 = ax.twinx()
angles = np.unwrap(np.angle(h))
plt.plot(w, angles, 'C1')
plt.ylabel('Angle (radians)', color='C1')
plt.axis('tight')
#plt.show()

t = np.linspace(0, 1, 42*60)
x = (np.sin(2*np.pi*60*t + 2.1) + 0.2* np.sin(2*np.pi*5*t + 1) + 0.1*np.sin(2*np.pi*2*t))
xn = x + np.random.randn(len(t)) * 0.08
x = xn + np.random.randn(len(t)) * 0.08

z = signal.lfilter(taps, 1.0, x)

fig = plt.figure()
ax = fig.add_subplot(1, 1, 1)
#plt.plot(t, x)
plt.plot(t, z)
ax.axis((0, .5, -2, 2))
plt.show()
